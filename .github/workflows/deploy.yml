name: Auto Deploy
on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  quality:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install Dependencies
        run: npm install --include=optional

      - name: Static Code Analysis
        run: npm run static-analysis

      - name: Build Validation
        run: npm run build

  deploy:
    needs: quality
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    runs-on: self-hosted
    env:
      PM2_HOME: /home/deploy/.pm2
      CLOUDFLARE_TUNNEL_TOKEN: ${{ secrets.CLOUDFLARE_TUNNEL_TOKEN }}
      CLOUDFLARE_HOSTNAME: lazzycal.com
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Build and Start
        run: |
          set -euo pipefail

          APP_DIR="/home/deploy/band-msg"
          REPO_URL="https://github.com/ayobro1/band-msg.git"

          # 1. Sync Code
          if [ -d "$APP_DIR/.git" ]; then
            cd "$APP_DIR"
            git fetch origin main
            git reset --hard origin/main
          else
            rm -rf "$APP_DIR"
            git clone "$REPO_URL" "$APP_DIR"
            cd "$APP_DIR"
          fi

          # 2. Build App
          npm install
          npm run build

          # 3. Start App via PM2
          pm2 delete band-msg || true
          pm2 start npm --name "band-msg" --cwd "$APP_DIR" -- start

          # 4. Handle Cloudflared (System Service Mode)
          if [ -z "${CLOUDFLARE_TUNNEL_TOKEN:-}" ]; then
            echo "CLOUDFLARE_TUNNEL_TOKEN is missing."
            exit 1
          fi

          if sudo -n true >/dev/null 2>&1; then
            echo "Passwordless sudo detected. Using cloudflared system service mode."

            if ! command -v cloudflared >/dev/null 2>&1; then
              echo "Installing cloudflared via .deb package..."
              curl -L --output cloudflared.deb https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64.deb
              sudo -n dpkg -i cloudflared.deb
            fi

            # Stop PM2 tunnel process to avoid conflicts with service mode
            pm2 delete band-msg-cloudflared || true

            sudo -n cloudflared service uninstall || true
            sudo -n cloudflared service install "$CLOUDFLARE_TUNNEL_TOKEN"
            sudo -n systemctl daemon-reload
            sudo -n systemctl restart cloudflared
            sudo -n systemctl is-active --quiet cloudflared
          else
            echo "No passwordless sudo available. Falling back to PM2 named tunnel mode."

            mkdir -p "$HOME/.local/bin"
            CLOUDFLARED_BIN="$HOME/.local/bin/cloudflared"

            if [ ! -x "$CLOUDFLARED_BIN" ]; then
              echo "Installing cloudflared binary to $CLOUDFLARED_BIN"
              curl -fsSL "https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64" -o "$CLOUDFLARED_BIN"
              chmod +x "$CLOUDFLARED_BIN"
            fi

            pm2 delete band-msg-cloudflared || true
            pm2 start "$CLOUDFLARED_BIN" --name "band-msg-cloudflared" -- tunnel run --token "$CLOUDFLARE_TUNNEL_TOKEN"
            if ! pm2 describe band-msg-cloudflared >/dev/null 2>&1; then
              echo "Cloudflared PM2 process was not created."
              exit 1
            fi
          fi

          echo "Deployment complete. Checking status..."
          pm2 status
          if sudo -n true >/dev/null 2>&1; then
            sudo -n systemctl status cloudflared --no-pager
          else
            pm2 logs band-msg-cloudflared --lines 20 --nostream
          fi