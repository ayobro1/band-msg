name: Auto Deploy
on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      deploy_ref:
        description: 'Branch, tag, or commit SHA to deploy (for rollback/manual deploy)'
        required: true
        default: 'main'

permissions:
  contents: read

concurrency:
  group: production-deploy
  cancel-in-progress: false

jobs:
  quality:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install Dependencies
        run: npm install --include=optional

      - name: Static Code Analysis
        run: npm run static-analysis

      - name: Build Validation
        run: npm run build

  deploy:
    needs: quality
    if: (github.event_name == 'push' && github.ref == 'refs/heads/main') || github.event_name == 'workflow_dispatch'
    runs-on: self-hosted
    timeout-minutes: 20
    environment: production
    env:
      PM2_HOME: /home/deploy/.pm2
      CLOUDFLARE_TUNNEL_TOKEN: ${{ secrets.CLOUDFLARE_TUNNEL_TOKEN }}
      CLOUDFLARE_HOSTNAME: lazzycal.com
      DEPLOY_REF: ${{ github.event.inputs.deploy_ref || github.sha }}
      SMOKE_URL: http://127.0.0.1:3000
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Build and Start
        run: |
          set -euo pipefail

          APP_DIR="/home/deploy/band-msg"
          REPO_URL="https://github.com/ayobro1/band-msg.git"
          DEPLOY_REF="${DEPLOY_REF:-main}"
          bash -s <<'DEPLOY_SCRIPT'
          set -euo pipefail

          APP_DIR="/home/deploy/band-msg"
          REPO_URL="https://github.com/ayobro1/band-msg.git"
          DEPLOY_REF="${DEPLOY_REF:-main}"

          echo "Deploying ref as deploy user: $DEPLOY_REF"

          pm2_count_by_name() {
            local process_name="$1"
            pm2 jlist | node -e '
              const fs = require("fs");
              const targetName = process.argv[1];
              const input = fs.readFileSync(0, "utf8");
              let list = [];
              try {
                list = JSON.parse(input);
              } catch {
                process.stdout.write("0");
                process.exit(0);
              }
              const count = list.filter((proc) => proc && proc.name === targetName).length;
              process.stdout.write(String(count));
            ' "$process_name"
          }

          # 1. Sync Code
          if [ -d "$APP_DIR/.git" ]; then
            cd "$APP_DIR"
            git fetch --all --tags --prune
            if git rev-parse --verify --quiet "origin/$DEPLOY_REF" >/dev/null; then
              git reset --hard "origin/$DEPLOY_REF"
            else
              git reset --hard "$DEPLOY_REF"
            fi
          else
            rm -rf "$APP_DIR"
            git clone "$REPO_URL" "$APP_DIR"
            cd "$APP_DIR"
            git fetch --all --tags --prune
            if git rev-parse --verify --quiet "origin/$DEPLOY_REF" >/dev/null; then
              git checkout -f "origin/$DEPLOY_REF"
            else
              git checkout -f "$DEPLOY_REF"
            fi
          fi

          # 2. Build App
          npm install
          npm run build

          # 3. Start App via PM2
          pm2 stop band-msg || true
          pm2 delete band-msg || true
          pm2 start npm --name "band-msg" --cwd "$APP_DIR" -- start

          BAND_MSG_COUNT="$(pm2_count_by_name "band-msg")"
          if [ "$BAND_MSG_COUNT" != "1" ]; then
            echo "Expected exactly one band-msg process, found $BAND_MSG_COUNT"
            pm2 status
            exit 1
          fi

          # 4. Handle Cloudflared (System Service Mode)
          if [ -z "${CLOUDFLARE_TUNNEL_TOKEN:-}" ]; then
            echo "CLOUDFLARE_TUNNEL_TOKEN is missing."
            exit 1
          fi

          if sudo -n true >/dev/null 2>&1; then
            echo "Passwordless sudo detected. Using cloudflared system service mode."

            if ! command -v cloudflared >/dev/null 2>&1; then
              echo "Installing cloudflared via .deb package..."
              curl -L --output cloudflared.deb https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64.deb
              sudo -n dpkg -i cloudflared.deb
            fi

            # Stop PM2 tunnel process to avoid conflicts with service mode
            pm2 stop band-msg-cloudflared || true
            pm2 delete band-msg-cloudflared || true

            CLOUDFLARED_PM2_COUNT="$(pm2_count_by_name "band-msg-cloudflared")"
            if [ "$CLOUDFLARED_PM2_COUNT" != "0" ]; then
              echo "Expected zero PM2 cloudflared processes in service mode, found $CLOUDFLARED_PM2_COUNT"
              pm2 status
              exit 1
            fi

            sudo -n cloudflared service uninstall || true
            sudo -n cloudflared service install "$CLOUDFLARE_TUNNEL_TOKEN"
            sudo -n systemctl daemon-reload
            sudo -n systemctl restart cloudflared
            sudo -n systemctl is-active --quiet cloudflared
          else
            echo "No passwordless sudo available. Falling back to PM2 named tunnel mode."

            mkdir -p "$HOME/.local/bin"
            CLOUDFLARED_BIN="$HOME/.local/bin/cloudflared"

            if [ ! -x "$CLOUDFLARED_BIN" ]; then
              echo "Installing cloudflared binary to $CLOUDFLARED_BIN"
              curl -fsSL "https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64" -o "$CLOUDFLARED_BIN"
              chmod +x "$CLOUDFLARED_BIN"
            fi

            pm2 stop band-msg-cloudflared || true
            pm2 delete band-msg-cloudflared || true
            pm2 start "$CLOUDFLARED_BIN" --name "band-msg-cloudflared" -- tunnel run --token "$CLOUDFLARE_TUNNEL_TOKEN"
            if ! pm2 describe band-msg-cloudflared >/dev/null 2>&1; then
              echo "Cloudflared PM2 process was not created."
              exit 1
            fi

            CLOUDFLARED_PM2_COUNT="$(pm2_count_by_name "band-msg-cloudflared")"
            if [ "$CLOUDFLARED_PM2_COUNT" != "1" ]; then
              echo "Expected exactly one PM2 cloudflared process, found $CLOUDFLARED_PM2_COUNT"
              pm2 status
              exit 1
            fi
          fi

          echo "Deployment complete. Checking status..."
          pm2 status
          if sudo -n true >/dev/null 2>&1; then
            sudo -n systemctl status cloudflared --no-pager
          else
            pm2 logs band-msg-cloudflared --lines 20 --nostream
          fi
          DEPLOY_SCRIPT

      - name: Smoke Check
        run: |
          set -euo pipefail
          SMOKE_URL="${SMOKE_URL:-http://127.0.0.1:3000}"
          echo "Running smoke checks against $SMOKE_URL"

          ATTEMPTS=20
          SLEEP_SECONDS=3
          for i in $(seq 1 "$ATTEMPTS"); do
            if curl -fsS "$SMOKE_URL" >/dev/null 2>&1; then
              echo "Smoke check passed on attempt $i"
              exit 0
            fi
            echo "Attempt $i/$ATTEMPTS failed; retrying in ${SLEEP_SECONDS}s..."
            sleep "$SLEEP_SECONDS"
          done

          echo "Smoke check failed after $ATTEMPTS attempts."
          pm2 status || true
          exit 1