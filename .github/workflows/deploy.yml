name: Auto Deploy
on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  quality:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install Dependencies
        run: npm install --include=optional

      - name: Static Code Analysis
        run: npm run static-analysis

      - name: Build Validation
        run: npm run build

  deploy:
    needs: quality
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    runs-on: self-hosted
    env:
      PM2_HOME: /home/deploy/.pm2
      CLOUDFLARE_TUNNEL_TOKEN: ${{ secrets.CLOUDFLARE_TUNNEL_TOKEN }}
      CLOUDFLARE_HOSTNAME: lazzycal.com
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Build and Start
        run: |
          set -euo pipefail

          APP_DIR="/home/deploy/band-msg"
          REPO_URL="https://github.com/ayobro1/band-msg.git"

          # 1. Sync Code
          if [ -d "$APP_DIR/.git" ]; then
            cd "$APP_DIR"
            git fetch origin main
            git reset --hard origin/main
          else
            rm -rf "$APP_DIR"
            git clone "$REPO_URL" "$APP_DIR"
            cd "$APP_DIR"
          fi

          # 2. Build App
          npm install
          npm run build

          # 3. Start App via PM2
          pm2 delete band-msg || true
          pm2 start npm --name "band-msg" --cwd "$APP_DIR" -- start

          # 4. Handle Cloudflared (System Service Mode)
          if ! command -v cloudflared >/dev/null 2>&1; then
            echo "Installing cloudflared..."
            curl -L --output cloudflared.deb https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64.deb
            sudo dpkg -i cloudflared.deb
          fi

          # We stop the PM2 version if it exists to avoid conflicts
          pm2 delete band-msg-cloudflared || true

          if [ -z "${CLOUDFLARE_TUNNEL_TOKEN:-}" ]; then
            echo "CLOUDFLARE_TUNNEL_TOKEN is missing."
            exit 1
          fi

          # Install/Update the official Cloudflare Service using your Token
          # This forces "Named Tunnel" mode and ignores "Quick Tunnels"
          sudo cloudflared service uninstall || true
          sudo cloudflared service install "$CLOUDFLARE_TUNNEL_TOKEN"

          # Restart to ensure it's using the latest token
          sudo systemctl daemon-reload
          sudo systemctl restart cloudflared

          echo "Deployment complete. Checking status..."
          pm2 status
          sudo systemctl status cloudflared --no-pager