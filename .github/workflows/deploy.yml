name: Auto Deploy
on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  quality:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install Dependencies
        run: npm install --include=optional

      - name: Static Code Analysis
        run: npm run static-analysis

      - name: Build Validation
        run: npm run build

  deploy:
    needs: quality
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    runs-on: self-hosted
    env:
      PM2_HOME: /home/deploy/.pm2
      CLOUDFLARE_TUNNEL_TOKEN: ${{ secrets.CLOUDFLARE_TUNNEL_TOKEN }}
      CLOUDFLARE_HOSTNAME: lazzycal.com
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Build and Start
        run: |
          set -euo pipefail

          APP_DIR="/home/deploy/band-msg"
          REPO_URL="https://github.com/ayobro1/band-msg.git"

          echo "whoami=$(whoami)"
          echo "PM2_HOME=$PM2_HOME"
          echo "workspace=$PWD"

          if [ -d "$APP_DIR/.git" ]; then
            cd "$APP_DIR"
            git fetch origin main
            git reset --hard origin/main
          elif [ -d "$APP_DIR" ]; then
            rm -rf "$APP_DIR"
            git clone "$REPO_URL" "$APP_DIR"
            cd "$APP_DIR"
          else
            git clone "$REPO_URL" "$APP_DIR"
            cd "$APP_DIR"
          fi

          node -v
          npm -v
          which node
          which npm
          which pm2

          node -e 'const major=Number(process.versions.node.split(".")[0]); if(major<20){console.error("Node 20+ required"); process.exit(1)}'

          npm install
          npm run build

          # Delete the old one and start fresh in the deploy user's list
          pm2 delete band-msg || true
          pm2 start npm --name "band-msg" --cwd "$APP_DIR" -- start

          echo "Waiting for app startup..."
          sleep 4
          if ! curl -fsS "http://127.0.0.1:3000" >/dev/null; then
            echo "App health check failed on http://127.0.0.1:3000"
            pm2 logs band-msg --lines 50 --nostream || true
            exit 1
          fi

          if [ -z "${CLOUDFLARE_TUNNEL_TOKEN:-}" ]; then
            echo "CLOUDFLARE_TUNNEL_TOKEN is missing. Named tunnel is required; quick tunnels are disabled."
            exit 1
          fi

          echo "Using Cloudflared named tunnel (token mode) for ${CLOUDFLARE_HOSTNAME}."
          mkdir -p "$HOME/.local/bin"
          CLOUDFLARED_BIN="$HOME/.local/bin/cloudflared"

          if [ ! -x "$CLOUDFLARED_BIN" ]; then
            echo "Installing cloudflared to $CLOUDFLARED_BIN"
            curl -fsSL "https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64" -o "$CLOUDFLARED_BIN"
            chmod +x "$CLOUDFLARED_BIN"
          fi

          pm2 delete band-msg-cloudflared || true
          pm2 start "$CLOUDFLARED_BIN" --name "band-msg-cloudflared" -- tunnel run --token "$CLOUDFLARE_TUNNEL_TOKEN"
          echo "Cloudflared named tunnel started for ${CLOUDFLARE_HOSTNAME}."

          if ! pm2 describe band-msg-cloudflared >/dev/null 2>&1; then
            echo "Cloudflared process was not created in PM2."
            exit 1
          fi

          echo "Waiting for tunnel startup..."
          sleep 4
          CLOUDFLARED_LOGS="$(pm2 logs band-msg-cloudflared --lines 60 --nostream || true)"
          if echo "$CLOUDFLARED_LOGS" | grep -qi "trycloudflare.com"; then
            echo "Detected quick tunnel output (trycloudflare.com). Named tunnel is required."
            exit 1
          fi

          if ! echo "$CLOUDFLARED_LOGS" | grep -qi "Registered tunnel connection"; then
            echo "Cloudflared did not report a registered tunnel connection."
            echo "$CLOUDFLARED_LOGS"
            exit 1
          fi

          pm2 logs band-msg-cloudflared --lines 20 --nostream

          pm2 save
          pm2 status
          pm2 logs band-msg --lines 20 --nostream